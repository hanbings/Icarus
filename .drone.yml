kind: pipeline
type: docker
name: Icarus

steps:
  - name: starplex-build
    image: gradle:jdk21
    commands:
      - cd starplex
      - gradle bootJar -x test

  - name: starplex-push
    image: plugins/docker
    depends_on: [ starplex-build ]
    settings:
      registry: registry.icaruspw.dev
      repo: registry.icaruspw.dev/icarus/starplex
      dockerfile: starplex/Dockerfile
      username: icarus
      password:
        from_secret: REGISTRY_PASSWORD
      auto_tag: true
      use_cache: true

  - name: starplex-wbe-build
    image: node:22
    commands:
      - cd starplex-web
      - npm install
      - npm run build

  - name: starplex-web-push
    image: plugins/docker
    depends_on: [ starplex-wbe-build ]
    settings:
      registry: registry.icaruspw.dev
      repo: registry.icaruspw.dev/icarus/starplex-web
      dockerfile: starplex-web/Dockerfile
      username: icarus
      password:
        from_secret: REGISTRY_PASSWORD
      auto_tag: true
      use_cache: true
